<ion-header translucent>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="home"></ion-back-button>
    </ion-buttons>
    <ion-title class="ion-text-center" *ngIf="conversation !== undefined">{{conversation.name}}</ion-title>

    <ion-button color="success" slot="end" fill="clear" shape="round" (click)="call()" *ngIf="conversation != undefined && conversation.userIds.length == 1">
      <ion-icon name="call-outline"></ion-icon>
    </ion-button>
  </ion-toolbar>
</ion-header>

<ion-content style="margin-bottom:50px">
  <ion-grid>
    <ion-row>
      <!-- Conversation Section -->
      <ion-col size="12">
        <ion-infinite-scroll threshold="0px" (ionInfinite)="loadMessages()" position="top">
          <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Loading more data...">
          </ion-infinite-scroll-content>
        </ion-infinite-scroll>

        <ion-list #messagelist style="background-color: transparent; margin-bottom: 42px;">
          <ion-item-sliding *ngFor="let message of messages" style="margin-bottom:1px">
            <ion-grid class="ion-no-padding">
              <ion-row *ngIf="message.repliedMessage != null">
                <ion-col style="margin-bottom: -10px;">
                  <ion-chip disabled color="medium" style="width: fit-content; max-width: 50%;"  [style]="message.userId !== currentUserId ? 'float:left;' : 'float:right;'">
                    <ion-note>{{message.repliedMessage.text}}</ion-note>
                  </ion-chip>
                </ion-col>
              </ion-row>
              <ion-row>
                <ion-col>
                  <ion-item color="primary" lines="none" style="width: fit-content; max-width: 75%; border-radius:20px;"
                  [style]="message.userId !== currentUserId ? 'float:left; border-bottom-left-radius: 0px;' : 'float:right; border-bottom-right-radius: 0px;'">
                  <ion-label class="ion-text-wrap">
                    {{message.text}}
                  </ion-label>
                </ion-item>
                </ion-col>
              </ion-row>
            </ion-grid>

            <ion-item-options [side]="message.userId !== currentUserId ? 'start' : 'end'" lines="none" (ionSwipe)="reply(message)">
            </ion-item-options>

          </ion-item-sliding>
        </ion-list>
      </ion-col>
    </ion-row>
  </ion-grid>
</ion-content>
<div class="inputBar">
  <ion-item lines="none" *ngIf="repliedMessage != null">
    <ion-label>
      Replying to {{repliedMessage.userId == currentUserId ? 'yourself' : ''}}
      <br>
      <ion-note>{{repliedMessage.text}}</ion-note>
    </ion-label>
    <ion-button color="medium" shape="round" fill="outline" size="small" (click)="cancelReply()">
      <ion-icon name="close-outline"></ion-icon>
    </ion-button>
  </ion-item>

  <ion-item class="corners" [style]="isMobile ? 'margin:4px' : 'margin-right:1%; margin-left:5px; margin-bottom:5px'" lines="none" color="light" >
    <ion-input type="text" #textCtrl="ngModel" ngModel (keyup.enter)="onSend(textCtrl)"></ion-input>
    <ion-button size="small" fill="clear" shape="round" (click)="onSend(textCtrl)">
      <ion-icon name="send-outline"></ion-icon>
    </ion-button>
  </ion-item>
</div>

